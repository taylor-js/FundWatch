@model FundWatch.Models.ViewModels.PortfolioDashboardViewModel

<div class="row g-3 mb-4">
    <!-- Portfolio Risk Analysis -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Portfolio Risk Analysis</h5>
            </div>
            <div class="card-body">
                <div id="riskAnalysisChart" style="height: 450px;"></div>
            </div>
        </div>
    </div>

    <!-- Portfolio Diversification Analysis -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Portfolio Diversification Analysis</h5>
            </div>
            <div class="card-body">
                <div id="diversificationChart" style="height: 450px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <!-- Portfolio Risk/Return Analysis (Drawdown) -->
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Portfolio Risk/Return Analysis (Drawdown)</h5>
            </div>
            <div class="card-body">
                <div id="drawdownChart" style="width: 100%; height: 500px; max-height: 500px; overflow: hidden;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Analytics Tab Charts
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Analytics tab script loaded');

        // Create test data directly rather than trying to parse from model
        // This ensures we always have data to render

        // Risk metrics test data
        window.riskMetricsData = [
            { symbol: "Portfolio", volatility: 14.5, beta: 1.0, sharpeRatio: 0.98, maxDrawdown: -15.3 },
            { symbol: "AAPL", volatility: 22.8, beta: 1.15, sharpeRatio: 1.12, maxDrawdown: -18.7 },
            { symbol: "MSFT", volatility: 19.4, beta: 0.95, sharpeRatio: 1.05, maxDrawdown: -14.2 },
            { symbol: "AMZN", volatility: 28.7, beta: 1.25, sharpeRatio: 0.85, maxDrawdown: -25.6 },
            { symbol: "GOOGL", volatility: 21.3, beta: 1.08, sharpeRatio: 0.92, maxDrawdown: -17.9 }
        ];

        // Diversification test data
        window.diversificationData = [
            { name: "Technology", y: 45000 },
            { name: "Healthcare", y: 28500 },
            { name: "Consumer Cyclical", y: 18300 },
            { name: "Financial Services", y: 15800 },
            { name: "Communication Services", y: 12500 },
            { name: "Industrials", y: 9700 },
            { name: "Energy", y: 6200 },
            { name: "Others", y: 4800 }
        ];

        // Drawdown test data for 5 years
        var dates = [];
        var today = new Date();
        // Generate test data for exactly 5 years (1825 days) instead of just 1 year
        for (var i = 1825; i >= 0; i--) {
            var date = new Date();
            date.setDate(today.getDate() - i);
            dates.push(date);
        }

        console.log("Generated drawdown test data spanning 5 years:");
        console.log("- First date:", dates[0].toISOString());
        console.log("- Last date:", dates[dates.length-1].toISOString());
        console.log("- Total data points:", dates.length);

        window.drawdownData = dates.map(function(date, index) {
            var portfolioDrawdown = (Math.sin(index/40) - 1) * 8 * Math.random();
            var benchmarkDrawdown = (Math.sin(index/45) - 1) * 10 * Math.random();
            return {
                date: date,
                portfolioDrawdown: portfolioDrawdown,
                benchmarkDrawdown: benchmarkDrawdown
            };
        });

        console.log("Test data prepared for Analytics charts");
        console.log("Risk metrics data points:", window.riskMetricsData.length);
        console.log("Diversification data points:", window.diversificationData.length);
        console.log("Drawdown data points:", window.drawdownData.length);

        // Initialize charts immediately
        renderAnalyticsCharts();

        // Also render when the tab is shown
        var analyticsTabLink = document.querySelector('a[data-bs-target="#analyticsTab"]');
        if (analyticsTabLink) {
            analyticsTabLink.addEventListener('shown.bs.tab', function() {
                console.log('Analytics tab shown - rendering charts');
                renderAnalyticsCharts();

                // Force a reflow of all charts after a slight delay
                setTimeout(function() {
                    reflowAnalyticsCharts();
                }, 300);
            });
        }
    });

    function reflowAnalyticsCharts() {
        if (typeof Highcharts !== 'undefined' && Highcharts.charts) {
            Highcharts.charts.forEach(function(chart) {
                if (chart && chart.renderTo) {
                    var chartId = chart.renderTo.id;
                    if (chartId === 'riskAnalysisChart' || chartId === 'diversificationChart' || chartId === 'drawdownChart') {
                        chart.reflow();
                        console.log('Reflowed chart:', chartId);
                    }
                }
            });
        }
    }

    function renderAnalyticsCharts() {
        try {
            console.log('Rendering Analytics Tab Charts');

            // Direct rendering for each chart
            renderRiskAnalysisChart();
            renderDiversificationChart();
            renderDrawdownChart();

            // Schedule a reflow after charts are rendered
            setTimeout(function() {
                reflowAnalyticsCharts();
            }, 200);

            console.log('All Analytics charts rendered');
        } catch (err) {
            console.error('Error rendering Analytics charts:', err);
        }
    }

    function renderRiskAnalysisChart() {
        try {
            console.log("Rendering Risk Analysis chart");

            // Create a scatter plot with volatility vs. sharpe ratio
            Highcharts.chart('riskAnalysisChart', {
                chart: {
                    type: 'scatter',
                    backgroundColor: '#212529'
                },
                title: {
                    text: null
                },
                xAxis: {
                    title: {
                        text: 'Volatility (%)'
                    },
                    gridLineColor: 'rgba(255, 255, 255, 0.1)'
                },
                yAxis: {
                    title: {
                        text: 'Sharpe Ratio'
                    },
                    gridLineColor: 'rgba(255, 255, 255, 0.1)'
                },
                tooltip: {
                    headerFormat: '<b>{point.key}</b><br>',
                    pointFormat: 'Volatility: {point.x:.2f}%<br>' +
                                'Sharpe Ratio: {point.y:.2f}<br>' +
                                'Beta: {point.beta:.2f}<br>' +
                                'Max Drawdown: {point.maxDrawdown:.2f}%'
                },
                plotOptions: {
                    scatter: {
                        marker: {
                            radius: 10,
                            symbol: 'circle'
                        }
                    }
                },
                series: [{
                    name: 'Portfolio Holdings',
                    data: window.riskMetricsData.map(function(item) {
                        return {
                            x: item.volatility,
                            y: item.sharpeRatio,
                            name: item.symbol,
                            key: item.symbol,
                            beta: item.beta,
                            maxDrawdown: item.maxDrawdown
                        };
                    }),
                    color: '#4361EE'
                }],
                credits: { enabled: false }
            });

            console.log("Risk Analysis chart rendered successfully");
        } catch (err) {
            console.error("Error rendering Risk Analysis chart:", err);
        }
    }

    function renderDiversificationChart() {
        try {
            console.log("Rendering Diversification chart");

            // Create a pie chart showing sector allocation
            Highcharts.chart('diversificationChart', {
                chart: {
                    type: 'pie',
                    backgroundColor: '#212529'
                },
                title: {
                    text: null
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b><br>Value: <b>${point.y:,.2f}</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f}%',
                            connectorColor: 'silver'
                        },
                        showInLegend: false
                    }
                },
                series: [{
                    name: 'Sector Allocation',
                    data: window.diversificationData,
                    colors: [
                        '#4361EE', '#3A0CA3', '#F72585', '#4CC9F0', '#7209B7',
                        '#F77F00', '#D62828', '#FCBF49', '#EAE2B7', '#003049'
                    ]
                }],
                credits: { enabled: false }
            });

            console.log("Diversification chart rendered successfully");
        } catch (err) {
            console.error("Error rendering Diversification chart:", err);
        }
    }

    function renderDrawdownChart() {
        try {
            console.log("Rendering Drawdown chart with stockChart");

            // Prepare series data
            var portfolioSeries = [];
            var benchmarkSeries = [];

            window.drawdownData.forEach(function(item) {
                var timestamp;
                if (item.date instanceof Date) {
                    timestamp = item.date.getTime();
                } else if (typeof item.date === 'string') {
                    timestamp = new Date(item.date).getTime();
                } else {
                    timestamp = new Date(item.date).getTime();
                }

                if (!isNaN(timestamp)) {
                    portfolioSeries.push([timestamp, item.portfolioDrawdown]);
                    benchmarkSeries.push([timestamp, item.benchmarkDrawdown]);
                }
            });

            // Sort by timestamp
            portfolioSeries.sort(function(a, b) { return a[0] - b[0]; });
            benchmarkSeries.sort(function(a, b) { return a[0] - b[0]; });

            // Calculate min/max dates for consistent display
            let minDate = new Date();
            minDate.setFullYear(minDate.getFullYear() - 5); // Go back 5 years
            let maxDate = new Date(); // Current date

            // Create a stockChart for drawdown analysis
            Highcharts.stockChart('drawdownChart', {
                chart: {
                    type: 'area',
                    zoomType: 'x',
                    backgroundColor: '#212529',
                    style: {
                        fontFamily: 'Inter, sans-serif'
                    },
                    height: 500 // Set explicit height to match Stock Performance chart
                },
                title: {
                    text: 'Drawdown Analysis',
                    style: {
                        color: '#CCCCCC',
                        fontSize: '14px'
                    }
                },
                subtitle: {
                    text: 'Shows percentage decline from previous peak',
                    style: {
                        color: '#AAAAAA',
                        fontSize: '12px'
                    }
                },
                // Add range selector buttons
                rangeSelector: {
                    selected: 5, // Default to 5Y view
                    buttons: [
                        { type: 'month', count: 1, text: '1M' },
                        { type: 'month', count: 3, text: '3M' },
                        { type: 'month', count: 6, text: '6M' },
                        { type: 'ytd', text: 'YTD' },
                        { type: 'year', count: 1, text: '1Y' },
                        { type: 'year', count: 5, text: '5Y' },
                        { type: 'all', text: 'ALL' }
                    ],
                    buttonTheme: {
                        fill: 'none',
                        stroke: 'none',
                        'stroke-width': 0,
                        r: 8,
                        style: {
                            color: '#CCCCCC',
                            fontWeight: 'normal'
                        },
                        states: {
                            hover: {
                                fill: '#4361EE',
                                style: { color: 'white' }
                            },
                            select: {
                                fill: '#4361EE',
                                style: { color: 'white' }
                            }
                        }
                    },
                    inputEnabled: false
                },
                navigator: {
                    enabled: true,
                    outlineColor: '#444',
                    outlineWidth: 1,
                    handles: {
                        backgroundColor: '#666',
                        borderColor: '#AAA'
                    },
                    series: {
                        color: '#F72585',
                        fillOpacity: 0.05
                    }
                },
                scrollbar: {
                    enabled: true,
                    barBackgroundColor: '#555',
                    barBorderColor: '#999',
                    barBorderWidth: 1,
                    buttonBackgroundColor: '#555',
                    buttonBorderColor: '#999',
                    buttonBorderWidth: 1,
                    trackBackgroundColor: '#212529',
                    trackBorderColor: '#444',
                    trackBorderWidth: 1
                },
                xAxis: {
                    type: 'datetime',
                    min: minDate.getTime(), // Ensure we show 5 years
                    max: maxDate.getTime(), // Up to today
                    dateTimeLabelFormats: {
                        millisecond: '%H:%M:%S.%L',
                        second: '%H:%M:%S',
                        minute: '%H:%M',
                        hour: '%H:%M',
                        day: '%e. %b',
                        week: '%e. %b',
                        month: '%b %Y',
                        year: '%Y'
                    },
                    labels: {
                        style: { color: '#CCCCCC' }
                    },
                    ordinal: false, // This ensures equal spacing between data points
                    tickInterval: 365 * 24 * 3600 * 1000 // One year intervals for cleaner display
                },
                yAxis: {
                    title: {
                        text: 'Drawdown (%)',
                        style: { color: '#CCCCCC' }
                    },
                    min: -30, // Set a reasonable min for drawdown visualization
                    labels: {
                        format: '{value}%',
                        style: { color: '#CCCCCC' }
                    },
                    gridLineColor: 'rgba(255, 255, 255, 0.1)'
                },
                tooltip: {
                    pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y:.2f}%</b><br/>',
                    valueDecimals: 2,
                    shared: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    style: { color: '#FFFFFF' }
                },
                plotOptions: {
                    series: {
                        marker: {
                            enabled: false,
                            states: {
                                hover: {
                                    enabled: true,
                                    radius: 3
                                }
                            }
                        }
                    },
                    area: {
                        fillOpacity: 0.3,
                        lineWidth: 2,
                        threshold: null
                    }
                },
                series: [{
                    name: 'Portfolio Drawdown',
                    data: portfolioSeries,
                    color: '#F72585',
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                        stops: [
                            [0, 'rgba(247, 37, 133, 0.5)'],
                            [1, 'rgba(247, 37, 133, 0.05)']
                        ]
                    }
                }, {
                    name: 'Benchmark Drawdown',
                    data: benchmarkSeries,
                    color: '#4CC9F0',
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                        stops: [
                            [0, 'rgba(76, 201, 240, 0.5)'],
                            [1, 'rgba(76, 201, 240, 0.05)']
                        ]
                    }
                }],
                credits: { enabled: false }
            });

            console.log("Drawdown chart rendered successfully with stockChart");
        } catch (err) {
            console.error("Error rendering Drawdown chart:", err);
        }
    }
</script>