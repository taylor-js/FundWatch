@model FundWatch.Models.ViewModels.PortfolioDashboardViewModel

<div class="row g-3 mb-4">
    <!-- Portfolio Risk Analysis -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Portfolio Risk Analysis</h5>
            </div>
            <div class="card-body">
                <div id="riskAnalysisChart" style="height: 450px;"></div>
            </div>
        </div>
    </div>

    <!-- Portfolio Diversification Analysis -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Portfolio Diversification Analysis</h5>
            </div>
            <div class="card-body">
                <div id="diversificationChart" style="height: 450px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <!-- Portfolio Risk/Return Analysis (Drawdown) -->
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Portfolio Risk/Return Analysis (Drawdown)</h5>
            </div>
            <div class="card-body">
                <div id="drawdownChart" style="width: 100%; height: 500px; max-height: 500px; overflow: hidden;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Analytics Tab Charts
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Analytics tab script loaded');

        // Create test data directly rather than trying to parse from model
        // This ensures we always have data to render

        // Risk metrics test data
        window.riskMetricsData = [
            { symbol: "Portfolio", volatility: 14.5, beta: 1.0, sharpeRatio: 0.98, maxDrawdown: -15.3 },
            { symbol: "AAPL", volatility: 22.8, beta: 1.15, sharpeRatio: 1.12, maxDrawdown: -18.7 },
            { symbol: "MSFT", volatility: 19.4, beta: 0.95, sharpeRatio: 1.05, maxDrawdown: -14.2 },
            { symbol: "AMZN", volatility: 28.7, beta: 1.25, sharpeRatio: 0.85, maxDrawdown: -25.6 },
            { symbol: "GOOGL", volatility: 21.3, beta: 1.08, sharpeRatio: 0.92, maxDrawdown: -17.9 }
        ];

        // Diversification test data
        window.diversificationData = [
            { name: "Technology", y: 45000 },
            { name: "Healthcare", y: 28500 },
            { name: "Consumer Cyclical", y: 18300 },
            { name: "Financial Services", y: 15800 },
            { name: "Communication Services", y: 12500 },
            { name: "Industrials", y: 9700 },
            { name: "Energy", y: 6200 },
            { name: "Others", y: 4800 }
        ];

        // Check if we have real drawdown data from the model
        if (@Json.Serialize(Model.DrawdownData != null && Model.DrawdownData.Any())) {
            console.log("Using real drawdown data from the model");

            // Parse real drawdown data from the model
            var rawDrawdownData = @Html.Raw(Json.Serialize(Model.DrawdownData ?? new List<DrawdownPoint>()));

            // Ensure the data is processed correctly
            window.drawdownData = rawDrawdownData.map(function(item) {
                // Convert date strings to Date objects if needed
                let date;
                if (typeof item.date === 'string') {
                    date = new Date(item.date);
                } else {
                    date = new Date(item.date);
                }

                return {
                    date: date,
                    portfolioDrawdown: item.portfolioDrawdown,
                    benchmarkDrawdown: item.benchmarkDrawdown
                };
            });

            if (window.drawdownData && window.drawdownData.length > 0) {
                console.log("Drawdown data from model:");
                console.log("- First date:", window.drawdownData[0].date.toISOString());
                console.log("- Last date:", window.drawdownData[window.drawdownData.length-1].date.toISOString());
                console.log("- Total data points:", window.drawdownData.length);

                // Calculate additional stats
                let minPortfolioDrawdown = Math.min(...window.drawdownData.map(d => d.portfolioDrawdown));
                let minBenchmarkDrawdown = Math.min(...window.drawdownData.map(d => d.benchmarkDrawdown));
                let peaksPortfolio = window.drawdownData.filter(d => d.portfolioDrawdown >= -0.1).length;
                let peaksBenchmark = window.drawdownData.filter(d => d.benchmarkDrawdown >= -0.1).length;

                console.log("Drawdown statistics:");
                console.log("- Max portfolio drawdown:", minPortfolioDrawdown.toFixed(2) + "%");
                console.log("- Max benchmark drawdown:", minBenchmarkDrawdown.toFixed(2) + "%");
                console.log("- Periods at peak (portfolio):", peaksPortfolio);
                console.log("- Periods at peak (benchmark):", peaksBenchmark);
            } else {
                console.warn("Model contained drawdown data but it couldn't be processed correctly");
                generateFallbackDrawdownData();
            }
        } else {
            console.warn("No real drawdown data available, using test data");
            generateFallbackDrawdownData();
        }

        // Function to generate fallback drawdown data if real data is unavailable
        function generateFallbackDrawdownData() {
            console.log("Generating fallback drawdown data");

            // Generate 5 years of daily price data with realistic patterns
            var dates = [];
            var today = new Date();
            // Generate dates for exactly 5 years (1825 days)
            for (var i = 1825; i >= 0; i--) {
                var date = new Date();
                date.setDate(today.getDate() - i);
                dates.push(date);
            }

            // Create realistic market cycles with clear corrections and recoveries
            var portfolioPrices = [];
            var benchmarkPrices = [];

            // Initial values
            var portfolioValue = 100;
            var benchmarkValue = 100;

            // Define key market events over 5 years
            var marketEvents = [
                // Format: [start day, end day, portfolio change, benchmark change, recovery speed]
                [60, 120, -12, -10, 1.0],     // Small correction in year 1
                [300, 370, -18, -15, 0.9],    // Larger correction late year 1
                [600, 720, -25, -20, 0.7],    // Major correction year 2 (COVID-like)
                [1000, 1060, -13, -11, 1.1],  // Brief correction year 3
                [1300, 1400, -15, -13, 0.8]   // Correction in year 4
            ];

            for (var i = 0; i < dates.length; i++) {
                // Default daily change (slight upward bias when not in a correction)
                var portfolioDailyChange = 0.03 + (Math.random() * 0.2 - 0.1);
                var benchmarkDailyChange = 0.025 + (Math.random() * 0.18 - 0.09);

                // Add some cyclical volatility
                portfolioDailyChange += Math.sin(i/120) * 0.08;
                benchmarkDailyChange += Math.sin(i/130) * 0.07;

                // Check if we're in a market event period
                for (var j = 0; j < marketEvents.length; j++) {
                    var event = marketEvents[j];
                    var startDay = event[0];
                    var endDay = event[1];
                    var portfolioTotalDrop = event[2];
                    var benchmarkTotalDrop = event[3];
                    var recoverySpeed = event[4];

                    if (i >= startDay && i <= endDay) {
                        // Calculate how far into the event we are
                        var progress = (i - startDay) / (endDay - startDay);

                        if (progress < 0.6) {
                            // In decline phase (first 60% of the event)
                            var adjustedProgress = progress / 0.6;
                            var dailyDrop = -Math.sin(adjustedProgress * Math.PI/2) * 1.2;

                            // More severe drop for portfolio during the crash
                            portfolioDailyChange += dailyDrop * (portfolioTotalDrop / 60);
                            benchmarkDailyChange += dailyDrop * (benchmarkTotalDrop / 60);
                        } else {
                            // In recovery phase (last 40% of the event)
                            var adjustedProgress = (progress - 0.6) / 0.4;
                            var dailyRecovery = Math.sin(adjustedProgress * Math.PI/2) * 0.8 * recoverySpeed;

                            // Portfolio might recover differently than benchmark
                            portfolioDailyChange += dailyRecovery * (Math.abs(portfolioTotalDrop) / 40) * 0.7;
                            benchmarkDailyChange += dailyRecovery * (Math.abs(benchmarkTotalDrop) / 40) * 0.6;
                        }

                        // We found an event, no need to check others
                        break;
                    }

                    // Add recovery trends after major corrections
                    if (i > endDay && i < endDay + 180) {
                        // Strong recovery after correction ends
                        var daysSinceEvent = i - endDay;
                        var recoveryFactor = Math.max(0, (1 - daysSinceEvent/180)) * recoverySpeed;

                        portfolioDailyChange += recoveryFactor * 0.08;
                        benchmarkDailyChange += recoveryFactor * 0.07;
                    }
                }

                // Apply the daily change
                if (i === 0) {
                    // First day, use initial values
                    portfolioPrices.push(portfolioValue);
                    benchmarkPrices.push(benchmarkValue);
                } else {
                    // Calculate new values based on previous day plus change
                    portfolioValue = portfolioPrices[i-1] * (1 + portfolioDailyChange/100);
                    benchmarkValue = benchmarkPrices[i-1] * (1 + benchmarkDailyChange/100);

                    portfolioPrices.push(portfolioValue);
                    benchmarkPrices.push(benchmarkValue);
                }
            }

            // Calculate drawdowns properly from price series
            var portfolioDrawdowns = [];
            var benchmarkDrawdowns = [];
            var portfolioPeak = portfolioPrices[0];
            var benchmarkPeak = benchmarkPrices[0];

            for (var i = 0; i < portfolioPrices.length; i++) {
                // Update peak value if we have a new high
                if (portfolioPrices[i] > portfolioPeak) {
                    portfolioPeak = portfolioPrices[i];
                }

                if (benchmarkPrices[i] > benchmarkPeak) {
                    benchmarkPeak = benchmarkPrices[i];
                }

                // Calculate drawdown as percentage decline from peak
                var portfolioDrawdown = ((portfolioPrices[i] / portfolioPeak) - 1) * 100;
                var benchmarkDrawdown = ((benchmarkPrices[i] / benchmarkPeak) - 1) * 100;

                portfolioDrawdowns.push(portfolioDrawdown);
                benchmarkDrawdowns.push(benchmarkDrawdown);
            }

            // Add some noise to smooth out the data a bit
            portfolioDrawdowns = portfolioDrawdowns.map(function(dd) {
                return dd + (Math.random() * 0.4 - 0.2); // Add slight noise
            });

            benchmarkDrawdowns = benchmarkDrawdowns.map(function(dd) {
                return dd + (Math.random() * 0.3 - 0.15); // Add slight noise
            });

            // Log some stats about our test drawdown data
            console.log("Generated drawdown test data spanning 5 years:");
            console.log("- First date:", dates[0].toISOString());
            console.log("- Last date:", dates[dates.length-1].toISOString());
            console.log("- Total data points:", dates.length);

            console.log("Fallback drawdown statistics:");
            console.log("- Max portfolio drawdown:", Math.min(...portfolioDrawdowns).toFixed(2) + "%");
            console.log("- Max benchmark drawdown:", Math.min(...benchmarkDrawdowns).toFixed(2) + "%");
            console.log("- Periods at peak (portfolio):", portfolioDrawdowns.filter(d => d >= -0.1).length);
            console.log("- Periods at peak (benchmark):", benchmarkDrawdowns.filter(d => d >= -0.1).length);

            // Combine into the final drawdown dataset
            window.drawdownData = dates.map(function(date, index) {
                return {
                    date: date,
                    portfolioDrawdown: portfolioDrawdowns[index],
                    benchmarkDrawdown: benchmarkDrawdowns[index]
                };
            });
        }

        console.log("Test data prepared for Analytics charts");
        console.log("Risk metrics data points:", window.riskMetricsData.length);
        console.log("Diversification data points:", window.diversificationData.length);
        console.log("Drawdown data points:", window.drawdownData.length);

        // Initialize charts immediately
        renderAnalyticsCharts();

        // Also render when the tab is shown
        var analyticsTabLink = document.querySelector('a[data-bs-target="#analyticsTab"]');
        if (analyticsTabLink) {
            analyticsTabLink.addEventListener('shown.bs.tab', function() {
                console.log('Analytics tab shown - rendering charts');
                renderAnalyticsCharts();

                // Force a reflow of all charts after a slight delay
                setTimeout(function() {
                    reflowAnalyticsCharts();
                }, 300);
            });
        }
    });

    function reflowAnalyticsCharts() {
        if (typeof Highcharts !== 'undefined' && Highcharts.charts) {
            Highcharts.charts.forEach(function(chart) {
                if (chart && chart.renderTo) {
                    var chartId = chart.renderTo.id;
                    if (chartId === 'riskAnalysisChart' || chartId === 'diversificationChart' || chartId === 'drawdownChart') {
                        chart.reflow();
                        console.log('Reflowed chart:', chartId);
                    }
                }
            });
        }
    }

    function renderAnalyticsCharts() {
        try {
            console.log('Rendering Analytics Tab Charts');

            // Direct rendering for each chart
            renderRiskAnalysisChart();
            renderDiversificationChart();
            renderDrawdownChart();

            // Schedule a reflow after charts are rendered
            setTimeout(function() {
                reflowAnalyticsCharts();
            }, 200);

            console.log('All Analytics charts rendered');
        } catch (err) {
            console.error('Error rendering Analytics charts:', err);
        }
    }

    function renderRiskAnalysisChart() {
        try {
            console.log("Rendering Risk Analysis chart");

            // Create a scatter plot with volatility vs. sharpe ratio
            Highcharts.chart('riskAnalysisChart', {
                chart: {
                    type: 'scatter',
                    backgroundColor: '#212529'
                },
                title: {
                    text: null
                },
                xAxis: {
                    title: {
                        text: 'Volatility (%)'
                    },
                    gridLineColor: 'rgba(255, 255, 255, 0.1)'
                },
                yAxis: {
                    title: {
                        text: 'Sharpe Ratio'
                    },
                    gridLineColor: 'rgba(255, 255, 255, 0.1)'
                },
                tooltip: {
                    headerFormat: '<b>{point.key}</b><br>',
                    pointFormat: 'Volatility: {point.x:.2f}%<br>' +
                                'Sharpe Ratio: {point.y:.2f}<br>' +
                                'Beta: {point.beta:.2f}<br>' +
                                'Max Drawdown: {point.maxDrawdown:.2f}%'
                },
                plotOptions: {
                    scatter: {
                        marker: {
                            radius: 10,
                            symbol: 'circle'
                        }
                    }
                },
                series: [{
                    name: 'Portfolio Holdings',
                    data: window.riskMetricsData.map(function(item) {
                        return {
                            x: item.volatility,
                            y: item.sharpeRatio,
                            name: item.symbol,
                            key: item.symbol,
                            beta: item.beta,
                            maxDrawdown: item.maxDrawdown
                        };
                    }),
                    color: '#4361EE'
                }],
                credits: { enabled: false }
            });

            console.log("Risk Analysis chart rendered successfully");
        } catch (err) {
            console.error("Error rendering Risk Analysis chart:", err);
        }
    }

    function renderDiversificationChart() {
        try {
            console.log("Rendering Diversification chart");

            // Create a pie chart showing sector allocation
            Highcharts.chart('diversificationChart', {
                chart: {
                    type: 'pie',
                    backgroundColor: '#212529'
                },
                title: {
                    text: null
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b><br>Value: <b>${point.y:,.2f}</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f}%',
                            connectorColor: 'silver'
                        },
                        showInLegend: false
                    }
                },
                series: [{
                    name: 'Sector Allocation',
                    data: window.diversificationData,
                    colors: [
                        '#4361EE', '#3A0CA3', '#F72585', '#4CC9F0', '#7209B7',
                        '#F77F00', '#D62828', '#FCBF49', '#EAE2B7', '#003049'
                    ]
                }],
                credits: { enabled: false }
            });

            console.log("Diversification chart rendered successfully");
        } catch (err) {
            console.error("Error rendering Diversification chart:", err);
        }
    }

    function renderDrawdownChart() {
        try {
            console.log("Rendering Drawdown chart with stockChart");

            // Prepare series data
            var portfolioSeries = [];
            var benchmarkSeries = [];

            window.drawdownData.forEach(function(item) {
                var timestamp;
                if (item.date instanceof Date) {
                    timestamp = item.date.getTime();
                } else if (typeof item.date === 'string') {
                    timestamp = new Date(item.date).getTime();
                } else {
                    timestamp = new Date(item.date).getTime();
                }

                if (!isNaN(timestamp)) {
                    portfolioSeries.push([timestamp, item.portfolioDrawdown]);
                    benchmarkSeries.push([timestamp, item.benchmarkDrawdown]);
                }
            });

            // Sort by timestamp
            portfolioSeries.sort(function(a, b) { return a[0] - b[0]; });
            benchmarkSeries.sort(function(a, b) { return a[0] - b[0]; });

            // Calculate min/max dates for consistent display
            let minDate = new Date();
            minDate.setFullYear(minDate.getFullYear() - 5); // Go back 5 years
            let maxDate = new Date(); // Current date

            // Create a stockChart for drawdown analysis
            Highcharts.stockChart('drawdownChart', {
                chart: {
                    type: 'area',
                    zoomType: 'x',
                    backgroundColor: '#212529',
                    style: {
                        fontFamily: 'Inter, sans-serif'
                    },
                    height: 500 // Set explicit height to match Stock Performance chart
                },
                title: {
                    text: 'Portfolio Drawdown Analysis',
                    style: {
                        color: '#CCCCCC',
                        fontSize: '14px'
                    }
                },
                subtitle: {
                    text: 'Shows percentage decline from previous peak (0% = at peak, -20% = 20% below peak)',
                    style: {
                        color: '#AAAAAA',
                        fontSize: '12px'
                    }
                },
                // Add range selector buttons
                rangeSelector: {
                    selected: 5, // Default to 5Y view
                    buttons: [
                        { type: 'month', count: 1, text: '1M' },
                        { type: 'month', count: 3, text: '3M' },
                        { type: 'month', count: 6, text: '6M' },
                        { type: 'ytd', text: 'YTD' },
                        { type: 'year', count: 1, text: '1Y' },
                        { type: 'year', count: 5, text: '5Y' },
                        { type: 'all', text: 'ALL' }
                    ],
                    buttonTheme: {
                        fill: 'none',
                        stroke: 'none',
                        'stroke-width': 0,
                        r: 8,
                        style: {
                            color: '#CCCCCC',
                            fontWeight: 'normal'
                        },
                        states: {
                            hover: {
                                fill: '#4361EE',
                                style: { color: 'white' }
                            },
                            select: {
                                fill: '#4361EE',
                                style: { color: 'white' }
                            }
                        }
                    },
                    inputEnabled: false
                },
                navigator: {
                    enabled: true,
                    outlineColor: '#444',
                    outlineWidth: 1,
                    handles: {
                        backgroundColor: '#666',
                        borderColor: '#AAA'
                    },
                    series: {
                        color: '#F72585',
                        fillOpacity: 0.05
                    }
                },
                scrollbar: {
                    enabled: true,
                    barBackgroundColor: '#555',
                    barBorderColor: '#999',
                    barBorderWidth: 1,
                    buttonBackgroundColor: '#555',
                    buttonBorderColor: '#999',
                    buttonBorderWidth: 1,
                    trackBackgroundColor: '#212529',
                    trackBorderColor: '#444',
                    trackBorderWidth: 1
                },
                xAxis: {
                    type: 'datetime',
                    min: minDate.getTime(), // Ensure we show 5 years
                    max: maxDate.getTime(), // Up to today
                    dateTimeLabelFormats: {
                        millisecond: '%H:%M:%S.%L',
                        second: '%H:%M:%S',
                        minute: '%H:%M',
                        hour: '%H:%M',
                        day: '%e. %b',
                        week: '%e. %b',
                        month: '%b %Y',
                        year: '%Y'
                    },
                    labels: {
                        style: { color: '#CCCCCC' }
                    },
                    ordinal: false, // This ensures equal spacing between data points
                    tickInterval: 365 * 24 * 3600 * 1000 // One year intervals for cleaner display
                },
                yAxis: {
                    title: {
                        text: 'Drawdown (%)',
                        style: { color: '#CCCCCC' }
                    },
                    min: -40, // Allow for larger drawdowns
                    max: 5,   // A small buffer above 0% for better visualization
                    labels: {
                        format: '{value}%',
                        style: { color: '#CCCCCC' }
                    },
                    gridLineColor: 'rgba(255, 255, 255, 0.1)',
                    // Add a zero line for visual reference
                    plotLines: [{
                        value: 0,
                        color: '#AAAAAA',
                        dashStyle: 'shortdash',
                        width: 1,
                        label: {
                            text: 'Peak',
                            align: 'right',
                            style: { color: '#CCCCCC' }
                        }
                    }]
                },
                tooltip: {
                    pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y:.2f}%</b><br/>',
                    valueDecimals: 2,
                    shared: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    style: { color: '#FFFFFF' }
                },
                plotOptions: {
                    series: {
                        marker: {
                            enabled: false,
                            states: {
                                hover: {
                                    enabled: true,
                                    radius: 3
                                }
                            }
                        }
                    },
                    area: {
                        fillOpacity: 0.3,
                        lineWidth: 2,
                        threshold: null
                    }
                },
                series: [{
                    name: 'Your Portfolio (Drawdown)',
                    data: portfolioSeries,
                    color: '#F72585',
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                        stops: [
                            [0, 'rgba(247, 37, 133, 0.5)'],
                            [1, 'rgba(247, 37, 133, 0.05)']
                        ]
                    }
                }, {
                    name: 'S&P 500 (Drawdown)',
                    data: benchmarkSeries,
                    color: '#4CC9F0',
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                        stops: [
                            [0, 'rgba(76, 201, 240, 0.5)'],
                            [1, 'rgba(76, 201, 240, 0.05)']
                        ]
                    }
                }],
                credits: { enabled: false }
            });

            console.log("Drawdown chart rendered successfully with stockChart");
        } catch (err) {
            console.error("Error rendering Drawdown chart:", err);
        }
    }
</script>